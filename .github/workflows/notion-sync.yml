name: Notion Content Sync

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # å®šæ—¶åŒæ­¥ï¼ˆæ¯å¤©ä¸Šåˆ9ç‚¹ï¼‰
  schedule:
    - cron: '0 9 * * *'

  # æ¨é€æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'docs/notion-content.md'

# è®¾ç½® GITHUB_TOKEN çš„æƒé™
permissions:
  contents: write

jobs:
  sync-notion:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci

      - name: Create .env file
        run: |
          cat > .env << EOF
          NOTION_TOKEN=${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}
          NOTION_MAIN_PAGE_ID=${{ secrets.NOTION_MAIN_PAGE_ID }}
          EOF

      - name: Verify environment variables
        run: |
          echo "æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®..."
          if [ -z "$NOTION_TOKEN" ]; then
            echo "âŒ NOTION_TOKEN æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  NOTION_TOKEN secret"
            exit 1
          fi
          if [ -z "$NOTION_DATABASE_ID" ]; then
            echo "âŒ NOTION_DATABASE_ID æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  NOTION_DATABASE_ID secret"
            exit 1
          fi
          if [ -z "$NOTION_MAIN_PAGE_ID" ]; then
            echo "âš ï¸ NOTION_MAIN_PAGE_ID æœªè®¾ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼"
          fi
          echo "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NOTION_MAIN_PAGE_ID: ${{ secrets.NOTION_MAIN_PAGE_ID }}

      - name: Sync Notion Content and Update Sidebar
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NOTION_MAIN_PAGE_ID: ${{ secrets.NOTION_MAIN_PAGE_ID }}
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥Notionå†…å®¹..."

          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p docs/.vitepress

          # åˆ›å»ºåŒæ­¥è„šæœ¬
          cat > sync-notion.js << 'EOF'
          import dotenv from 'dotenv';
          import fetch from 'node-fetch';
          import fs from 'fs';

          dotenv.config();

          const NOTION_TOKEN = process.env.NOTION_TOKEN;
          const DATABASE_ID = process.env.NOTION_DATABASE_ID;

          async function syncNotionContent() {
            try {
              console.log('ğŸ”„ å¼€å§‹åŒæ­¥Notionå†…å®¹...');

              // éªŒè¯å¿…è¦çš„å‚æ•°
              if (!NOTION_TOKEN) {
                throw new Error('NOTION_TOKEN æœªè®¾ç½®');
              }
              if (!DATABASE_ID) {
                throw new Error('NOTION_DATABASE_ID æœªè®¾ç½®');
              }

              // è·å–æ•°æ®åº“ä¿¡æ¯
              console.log('ğŸ“Š æ­£åœ¨è·å–æ•°æ®åº“ä¿¡æ¯...');
              const dbResponse = await fetch(`https://api.notion.com/v1/databases/${DATABASE_ID}`, {
                headers: {
                  'Authorization': NOTION_TOKEN,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                }
              });

              if (!dbResponse.ok) {
                if (dbResponse.status === 401) {
                  throw new Error('NOTION_TOKEN æ— æ•ˆæˆ–è¿‡æœŸ');
                } else if (dbResponse.status === 404) {
                  throw new Error('NOTION_DATABASE_ID ä¸æ­£ç¡®');
                } else {
                  throw new Error(`æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: ${dbResponse.status} ${dbResponse.statusText}`);
                }
              }

              const dbData = await dbResponse.json();
              console.log(`ğŸ“Š æ•°æ®åº“æ ‡é¢˜: ${dbData.title[0]?.text?.content || 'Untitled'}`);

              // è·å–æ–‡ç« åˆ—è¡¨
              console.log('ğŸ“ æ­£åœ¨è·å–æ–‡ç« åˆ—è¡¨...');
              const postsResponse = await fetch(`https://api.notion.com/v1/databases/${DATABASE_ID}/query`, {
                method: 'POST',
                headers: {
                  'Authorization': NOTION_TOKEN,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify({
                  filter: {
                    property: 'Status',
                    select: {
                      equals: 'Published'
                    }
                  },
                  sorts: [
                    {
                      property: 'Created',
                      direction: 'descending'
                    }
                  ]
                })
              });

              if (!postsResponse.ok) {
                throw new Error(`æ–‡ç« æŸ¥è¯¢å¤±è´¥: ${postsResponse.status} ${postsResponse.statusText}`);
              }

              const postsData = await postsResponse.json();
              console.log(`ğŸ“ æ‰¾åˆ° ${postsData.results.length} ç¯‡å·²å‘å¸ƒæ–‡ç« `);

              // ç”Ÿæˆå†…å®¹æ‘˜è¦
              const summary = {
                totalPosts: postsData.results.length,
                lastSync: new Date().toISOString(),
                status: 'success',
                message: 'åŒæ­¥æˆåŠŸ',
                posts: postsData.results.map(page => ({
                  id: page.id,
                  title: page.properties.Title?.title?.[0]?.text?.content || 'Untitled',
                  status: page.properties.Status?.select?.name || 'Unknown',
                  createdTime: page.created_time,
                  lastEditedTime: page.last_edited_time
                }))
              };

              // ä¿å­˜åŒæ­¥ä¿¡æ¯
              fs.writeFileSync('docs/.vitepress/notion-sync.json', JSON.stringify(summary, null, 2));

              console.log('âœ… Notionå†…å®¹åŒæ­¥å®Œæˆ');

            } catch (error) {
              console.error('âŒ åŒæ­¥å¤±è´¥:', error.message);

              // ä¿å­˜é”™è¯¯ä¿¡æ¯
              const errorSummary = {
                totalPosts: 0,
                lastSync: new Date().toISOString(),
                status: 'error',
                message: error.message,
                error: error.message
              };

              fs.writeFileSync('docs/.vitepress/notion-sync.json', JSON.stringify(errorSummary, null, 2));

              // ä¸é€€å‡ºè¿›ç¨‹ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
              console.log('âš ï¸ ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤...');
            }
          }

          syncNotionContent();
          EOF

          # è¿è¡ŒåŒæ­¥è„šæœ¬
          node sync-notion.js

          # è¿è¡Œé¡µé¢åˆå¹¶è„šæœ¬ï¼ˆç½‘ç»œå®‰å…¨é¡µé¢ï¼‰
          echo "ğŸ”„ å¼€å§‹åˆå¹¶ç½‘ç»œå®‰å…¨ç›¸å…³é¡µé¢..."
          if node merge-notion-pages-optimized.js; then
            echo "âœ… ç½‘ç»œå®‰å…¨é¡µé¢åˆå¹¶æˆåŠŸ"
          else
            echo "âš ï¸ ç½‘ç»œå®‰å…¨é¡µé¢åˆå¹¶å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
          fi

          # è¿è¡Œä¾§è¾¹æ é…ç½®æ›´æ–°è„šæœ¬
          echo "ğŸ”„ å¼€å§‹æ›´æ–°ä¾§è¾¹æ é…ç½®..."
          if node update-sidebar-merged.js; then
            echo "âœ… ä¾§è¾¹æ é…ç½®æ›´æ–°æˆåŠŸ"
          else
            echo "âš ï¸ ä¾§è¾¹æ é…ç½®æ›´æ–°å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
          fi
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ å¯èƒ½æ›´æ”¹çš„æ–‡ä»¶
          git add docs/.vitepress/notion-sync.json || true
          git add docs/.vitepress/config.mjs || true

          if git diff --quiet --cached; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥Notionå†…å®¹å’Œæ›´æ–°ä¾§è¾¹æ  - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi

      # éƒ¨ç½²ç”± deploy.yml å·¥ä½œæµè‡ªåŠ¨å¤„ç†
      # å½“å†…å®¹è¢«æ¨é€åï¼Œdeploy.yml ä¼šè‡ªåŠ¨è§¦å‘æ„å»ºå’Œéƒ¨ç½²
