name: Notion Content Sync

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶åŒæ­¥ï¼ˆæ¯å¤©ä¸Šåˆ9ç‚¹ï¼‰
  schedule:
    - cron: '0 9 * * *'
  
  # æ¨é€æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'docs/notion-content.md'

jobs:
  sync-notion:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Sync Notion Content
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          # åˆ›å»ºåŒæ­¥è„šæœ¬
          cat > sync-notion.js << 'EOF'
          import dotenv from 'dotenv';
          import fetch from 'node-fetch';
          import fs from 'fs';
          
          dotenv.config();
          
          const NOTION_TOKEN = process.env.NOTION_TOKEN;
          const DATABASE_ID = process.env.NOTION_DATABASE_ID;
          
          async function syncNotionContent() {
            try {
              console.log('ğŸ”„ å¼€å§‹åŒæ­¥Notionå†…å®¹...');
              
              // è·å–æ•°æ®åº“ä¿¡æ¯
              const dbResponse = await fetch(`https://api.notion.com/v1/databases/${DATABASE_ID}`, {
                headers: {
                  'Authorization': NOTION_TOKEN,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                }
              });
              
              if (!dbResponse.ok) {
                throw new Error(`æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: ${dbResponse.statusText}`);
              }
              
              const dbData = await dbResponse.json();
              console.log(`ğŸ“Š æ•°æ®åº“æ ‡é¢˜: ${dbData.title[0]?.text?.content || 'Untitled'}`);
              
              // è·å–æ–‡ç« åˆ—è¡¨
              const postsResponse = await fetch(`https://api.notion.com/v1/databases/${DATABASE_ID}/query`, {
                method: 'POST',
                headers: {
                  'Authorization': NOTION_TOKEN,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify({
                  filter: {
                    property: 'Status',
                    select: {
                      equals: 'Published'
                    }
                  },
                  sorts: [
                    {
                      property: 'Created',
                      direction: 'descending'
                    }
                  ]
                })
              });
              
              if (!postsResponse.ok) {
                throw new Error(`æ–‡ç« æŸ¥è¯¢å¤±è´¥: ${postsResponse.statusText}`);
              }
              
              const postsData = await postsResponse.json();
              console.log(`ğŸ“ æ‰¾åˆ° ${postsData.results.length} ç¯‡å·²å‘å¸ƒæ–‡ç« `);
              
              // ç”Ÿæˆå†…å®¹æ‘˜è¦
              const summary = {
                totalPosts: postsData.results.length,
                lastSync: new Date().toISOString(),
                posts: postsData.results.map(page => ({
                  id: page.id,
                  title: page.properties.Title?.title?.[0]?.text?.content || 'Untitled',
                  status: page.properties.Status?.select?.name || 'Unknown',
                  createdTime: page.created_time,
                  lastEditedTime: page.last_edited_time
                }))
              };
              
              // ä¿å­˜åŒæ­¥ä¿¡æ¯
              fs.writeFileSync('docs/.vitepress/notion-sync.json', JSON.stringify(summary, null, 2));
              
              console.log('âœ… Notionå†…å®¹åŒæ­¥å®Œæˆ');
              
            } catch (error) {
              console.error('âŒ åŒæ­¥å¤±è´¥:', error.message);
              process.exit(1);
            }
          }
          
          syncNotionContent();
          EOF
          
          # è¿è¡ŒåŒæ­¥è„šæœ¬
          node sync-notion.js
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          else
            git add docs/.vitepress/notion-sync.json
            git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥Notionå†…å®¹ - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi
      
      - name: Trigger Pages Build
        run: |
          echo "ğŸš€ è§¦å‘GitHub Pagesé‡æ–°æ„å»º"
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pages/builds
